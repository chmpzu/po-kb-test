<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>PO Knowledge Base</title>
  <style>
    :root{--primary:#333;--accent:#ffb900;--text:#4a4a4a;--bg:#f5f5f5;--header-height:60px}
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;padding:0;font-family:'Segoe UI',Tahoma,sans-serif;background:var(--bg);color:var(--text)}
    header{position:fixed;top:0;left:0;right:0;height:var(--header-height);background:#fff;border-bottom:1px solid #ddd;display:flex;align-items:center;padding:0 1rem;z-index:1000}
    header img{height:40px;margin-right:1rem}
    header h1{margin:0;font-size:1.25rem;color:var(--primary)}
    .search-wrapper{position:relative;margin-left:auto}
    #searchInput{padding:.5rem;font-size:1rem;border:1px solid #ccc;border-radius:4px;width:200px}
    #searchResults{position:absolute;top:110%;left:0;right:0;background:#fff;border:1px solid #ccc;border-radius:4px;list-style:none;margin:0;padding:0;max-height:250px;overflow-y:auto;z-index:1001}
    #searchResults li{padding:.5rem;cursor:pointer}
    #searchResults li:hover{background:var(--bg)}
    nav{position:fixed;top:var(--header-height);left:0;bottom:0;width:220px;background:var(--primary);padding:1rem;overflow-y:auto}
    nav h3{color:var(--accent);margin:0 0 1rem;font-size:1rem}
    nav a{display:block;color:#fff;text-decoration:none;padding:.5rem;border-radius:4px;margin-bottom:.25rem;transition:background .2s}
    nav a:hover{background:var(--accent);color:var(--primary)}
    .container{display:flex;margin-top:var(--header-height)}
    #detail-view{flex:1;padding:2rem;margin:0 320px 0 220px;background:#fff}
    #announcement-panel{position:fixed;top:var(--header-height);right:0;bottom:0;width:300px;background:#fff;border-left:1px solid #ddd;padding:1rem;overflow-y:auto}
    h2{margin-top:0;color:var(--primary);border-bottom:2px solid var(--accent);padding-bottom:.5rem}
    h3.section{margin-top:2rem;color:var(--primary);font-size:1.1rem;border-bottom:1px solid #ddd;padding-bottom:.25rem}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{border:1px solid #ddd;padding:.75rem;text-align:left}
    .cards-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem;margin-top:1rem}
    .card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:1.25rem;box-shadow:0 2px 4px rgba(0,0,0,.1);display:flex;flex-direction:column}
    .badge{display:inline-block;background:var(--primary);color:#fff;font-size:.75rem;font-weight:600;text-transform:uppercase;padding:.25rem .75rem;border-radius:12px;align-self:center;margin-bottom:.75rem}
    .card h4{margin:0 0 .5rem;color:var(--primary);font-size:1rem}
    .description{flex:1;font-size:.875rem;line-height:1.4;color:var(--text);margin-bottom:1rem}
    .actions{display:flex;gap:1rem}
    .actions a{position:relative;text-decoration:none;font-size:.875rem;font-weight:600;color:var(--primary);display:inline-flex;align-items:center}
    .actions a::after{content:'â†’';margin-left:.25rem}
    .actions a:hover{color:var(--accent)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
</head>
<body>
  <header>
    <img src="/mnt/data/c989c696-b542-4bf6-91df-5ff482249ad3.png" alt="Karparts360 Logo">
    <h1>PO Knowledge Base</h1>
    <div class="search-wrapper">
      <input id="searchInput" type="search" placeholder="Search KB...">
      <ul id="searchResults"></ul>
    </div>
  </header>
  <nav>
    <h3>Navigate</h3>
    <a href="#dashboard">Dashboard</a>
    <a href="#email">Email Templates</a>
    <a href="#trackers">Trackers</a>
    <a href="#ratings">Marketplace Ratings</a>
    <a href="#sops">SOPs</a>
    <a href="#reports">Reports</a>
    <a href="#suppliers">Supplier Contacts</a>
    <a href="#tasks">Task List</a>
    <a href="#processors">Processors</a>
  </nav>
  <div class="container">
    <div id="detail-view">
      <h2>Welcome</h2>
      <p>Select a section from the navigation to view details here.</p>
    </div>
    <aside id="announcement-panel">
      <h2>Announcements</h2>
      <ul></ul>
    </aside>
  </div>

  <div id="templates" style="display:none;">
    <div data-template="dashboard"><h2>Dashboard</h2><p>Overview of quick links and recent updates.</p></div>
    <div data-template="email"><h2>Email Templates</h2><ul><li>Customer Outreach</li><li>Internal Notifications</li><li>Supplier Requests</li></ul><p><em>Suggest new templates via the submission form.</em></p></div>
    <div data-template="trackers"><h2>Trackers</h2><ul><li>Order Fulfillment Status</li><li>Inventory Levels</li><li>Marketing Campaign Performance</li></ul></div>
    <div data-template="ratings"><h2>Marketplace Performance Ratings</h2><p>KPIs and scorecards for seller ratings, return rates, on-time delivery.</p></div>
    <div data-template="sops"><h2>SOPs</h2><ul><li>Sales</li><li>Procurement</li><li>Logistics</li><li>Customer Service</li></ul></div>
    <div data-template="reports"><h2>Reports</h2><table><thead><tr><th>Report</th><th>Frequency</th><th>Owner</th></tr></thead><tbody><tr><td>Sales Dashboard</td><td>Daily</td><td>Sales Team</td></tr><tr><td>P&L Report</td><td>Monthly</td><td>Finance</td></tr></tbody></table></div>
    <div data-template="suppliers"><h2>Supplier Contacts</h2><table><thead><tr><th>Supplier</th><th>Contact</th><th>Email</th><th>Phone</th><th>Region</th><th>Status</th></tr></thead><tbody><tr><td>Example Co.</td><td>Jane Doe</td><td>jane@example.com</td><td>+1 555-0100</td><td>NA</td><td>Active</td></tr></tbody></table></div>
    <div data-template="tasks"><h2>Task List</h2><p>Kanban: Backlog, In Progress, Review, Done.</p></div>
  </div>

  <script>
    function parseGoogleDate(str) {
      const m = /^Date\(([\d,]+)\)$/.exec(str);
      if (!m) return new Date(str);
      const [y,mo,d,h,mi,s] = m[1].split(',').map(Number);
      return new Date(y,mo,d,h,mi,s);
    }
    function formatTimestamp(d) {
      let h = d.getHours(), ampm = h < 12 ? 'AM' : 'PM';
      h = h % 12 || 12;
      const MM = String(d.getMonth()+1).padStart(2,'0'),
            DD = String(d.getDate()).padStart(2,'0'),
            YYYY = d.getFullYear(),
            hh = String(h).padStart(2,'0'),
            mm = String(d.getMinutes()).padStart(2,'0');
      return `${MM}/${DD}/${YYYY} ${hh}:${mm} ${ampm}`;
    }
    const SHEET_ID = '1zWuPjF-bTWWRTtbs9BLWJk3w4h7Xrpi5oqyUbi6Oqrg';
    async function fetchSheet(tab) {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(tab)}&tqx=out:json`,
            text = await (await fetch(url)).text(),
            table = JSON.parse(text.substr(47).slice(0,-2)).table;
      return table.rows.map(r => r.c.map(c => c && c.v));
    }
    async function loadPOKB() {
      try {
        const rows = await fetchSheet('Announcements'),
              ul = document.querySelector('#announcement-panel ul');
        ul.innerHTML = rows.length
          ? rows.map((r,i) => {
              const dt = typeof r[0]==='string' ? parseGoogleDate(r[0]) : new Date(r[0]),
                    time = formatTimestamp(dt),
                    id = `ann-${i}`;
              return `<li><span class="ann-time">${time}</span><a href="#${id}" class="ann-link">${r[1]}</a></li>`;
            }).join('')
          : '<li class="italic">No announcements.</li>';
      } catch(e){ console.error(e) }
      try {
        const data = (await fetchSheet('Email Templates')).slice(1),
              container = document.querySelector('[data-template="email"]'),
              groups = {};
        data.forEach(([cat,name,content]) => (groups[cat]=groups[cat]||[]).push({name,content}));
        container.innerHTML = '<h2>Email Templates</h2>' + 
          Object.entries(groups).map(([cat,items]) =>
            `<h3 class="section">${cat.toUpperCase()}</h3><ul>` +
            items.map(i=>`<li><a href="#" class="email-template-link" data-content="${i.content}">${i.name}</a></li>`).join('') +
            `</ul>`
          ).join('');
      } catch(e){ console.error(e) }
    }
    async function loadMoreSheets() {
      try {
        const sops = await fetchSheet('SOPs');
        document.querySelector('[data-template="sops"]').innerHTML =
          `<h2>SOPs</h2><ul>${sops.map(r=>`<li><a href="${r[2]}" target="_blank">${r[1]}</a></li>`).join('')}</ul>`;
      } catch{}
      try {
        const tr = (await fetchSheet('Trackers')).slice(1),
              tDiv = document.querySelector('[data-template="trackers"]');
        tDiv.innerHTML = tr.length
          ? `<h2>Trackers</h2><ul>${tr.map(r=>`<li><a href="${r[2]||'#'}">${r[1]||'Untitled'}</a></li>`).join('')}</ul>`
          : '<h2>Trackers</h2><p class="italic">No trackers available.</p>';
      } catch{}
      try {
        const sup = (await fetchSheet('Supplier Contacts')).slice(1),
              tb = document.querySelector('[data-template="suppliers"] tbody');
        tb.innerHTML = sup.map(r=>`<tr>${r.map(c=>`<td>${c||''}</td>`).join('')}</tr>`).join('');
      } catch{}
      document.querySelectorAll('.ann-link').forEach(link => {
        link.onclick = e => {
          e.preventDefault();
          const tpl = document.querySelector(`[data-template="${link.hash.slice(1)}"]`);
          document.getElementById('detail-view').innerHTML = tpl.innerHTML;
        };
      });
    }
    function initSearchNav() {
      const items = [];
      document.querySelectorAll('nav a').forEach(a => items.push({key:a.hash.slice(1),title:a.textContent}));
      document.querySelectorAll('#templates [data-template]').forEach(div => {
        const h = div.querySelector('h2');
        if (h) items.push({key:div.dataset.template,title:h.textContent});
      });
      const fuse = new Fuse(items,{keys:['title'],threshold:0.3}),
            inp = document.getElementById('searchInput'),
            res = document.getElementById('searchResults');
      inp.oninput = () => {
        const q = inp.value.trim();
        res.innerHTML = '';
        if (!q) return;
        fuse.search(q,{limit:10}).forEach(m => {
          const li = document.createElement('li');
          li.textContent = m.item.title;
          li.onclick = () => {
            document.getElementById('detail-view').innerHTML =
              document.querySelector(`[data-template="${m.item.key}"]`).innerHTML;
            res.innerHTML = '';
            inp.value = '';
          };
          res.append(li);
        });
      };
      document.querySelectorAll('nav a').forEach(link => {
        link.onclick = e => {
          e.preventDefault();
          document.getElementById('detail-view').innerHTML =
            document.querySelector(`[data-template="${link.hash.slice(1)}"]`).innerHTML;
        };
      });
    }
document.addEventListener('DOMContentLoaded', () => {
  loadPOKB();
  loadMoreSheets();
  initSearchNav();

  const procLink = document.querySelector('nav a[href="#processors"]');
  procLink.addEventListener('click', async e => {
    e.preventDefault();
    const detail = document.getElementById('detail-view');
    detail.innerHTML = '<p>Loading processorsâ€¦</p>';
    try {
      const resp = await fetch('processors.html');
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const text = await resp.text();

      // parse only the <body> of processors.html
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      detail.innerHTML = doc.body.innerHTML;

    } catch (err) {
      console.error('Error loading processors.html', err);
      detail.innerHTML = `<p class="error">Could not load processors: ${err.message}</p>`;
    }
  });

  // if page loaded with #processors in URL, simulate a click
  if (location.hash === '#processors') {
    procLink.click();
  }
});

  </script>
</body>
</html>
